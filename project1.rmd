---
title: "Project 1"
output: html_document
---


##                 "How old is the mussel"

```{r setup, echo = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```
This report contains statistical processing of data on mollusks. This data containes such parameters of mollusk as the number of rings, sex (male, female and child), length, diameter and others. 

## 1. Preparing to work

#### 1.1 Libraries

Before we start analyzing our dataset, we should install libraries that we need for work:

```{r libraries, echo = TRUE, message = FALSE, warning=FALSE}
if(!require("plyr")) install.packages("plyr")
if(!require("readr")) install.packages("readr")
if(!require("dplyr")) install.packages("dplyr")
if(!require("anchors")) install.packages("anchors")
if(!require("ggcorrplot")) install.packages("ggcorrplot")
if(!require("ggplot2")) install.packages("ggplot2")
if(!require("GGally")) install.packages("GGally")
if(!require("RColorBrewer")) install.packages("RColorBrewer")
if(!require("lsr")) install.packages("lsr")

```

#### 1.2 Data compilation

And we also have to load all of our data in a single data frame:

```{r view data, echo = TRUE, message = FALSE}
path = '/home/asha/ИБ/statisticsR/project/BI_Stat_2020/data/Data/'

loading_data <- function(path){
  data <-  ldply(list.files(path=path, pattern="*.csv", full.names=TRUE), read_csv)
  tibble(data)
}
dat_mollusk <-  loading_data(path)
dat_mollusk <- as.data.frame(dat_mollusk)
```
The following table represents the structure of data columns and their types:
```{r data str}
print(str(dat_mollusk))
```

#### 1.3 Initial data preparation

First of all, we should examine our data and fix bad values. Here are some rows with incorrect types of certain values, that can easily be fixed:

```{r fix values, echo=T}
dat_mollusk <- dat_mollusk %>% replace.value('Sex (1 – male, 2 – female, 3 – uvenil)', from = 'three', to=as.integer(3), verbose = FALSE)
dat_mollusk <- dat_mollusk %>% replace.value('Sex (1 – male, 2 – female, 3 – uvenil)', from = 'male', to=as.integer(1), verbose = FALSE)
dat_mollusk <- dat_mollusk %>% replace.value('Sex (1 – male, 2 – female, 3 – uvenil)', from = 'one', to=as.integer(1), verbose = FALSE)
dat_mollusk <- dat_mollusk %>% replace.value('Rings', from = 'nine', to=as.integer(9), verbose = FALSE)
dat_mollusk <- dat_mollusk[-3339, ]  #No data! I forgot to mesure it!(
dat_mollusk <- dat_mollusk[-343, ] #undefined sex
```

We can change the NAs in columns Length, Diameter, Height, etc. with the median of the values, because 
these variables vary continuously in a certain range, which means that they can take all values from it. The median is most resistant to outliers, that is why it was chosen instead of mean value.
We can`t though change column 'sex' with the mean/median because here we are supposed to have factor.  There is only one row where sex is undefined, so it can be removed without significant loss of quality.

```{r def values, message=FALSE}

dat_mollusk$Length <- as.double(dat_mollusk$Length, na.rm = TRUE)
dat_mollusk$Diameter <- as.double(dat_mollusk$Diameter, na.rm = TRUE) 
dat_mollusk$Height <- as.double(dat_mollusk$Height, na.rm = TRUE)
dat_mollusk$Rings <- as.integer(dat_mollusk$Rings, na.rm = TRUE)

#Replace NAs with median where possible
dat_mollusk <- dat_mollusk %>%
  mutate(Length = coalesce(Length, median(dat_mollusk$Length, na.rm = TRUE)),
         Diameter = coalesce(Diameter, median(dat_mollusk$Diameter, na.rm = TRUE)),
         Height = coalesce(Height, median(dat_mollusk$Height, na.rm = TRUE)),
         Shell_weight = coalesce(Shell_weight, median(dat_mollusk$Shell_weight, na.rm = TRUE)),
         Shucked_weight = coalesce(Shucked_weight, median(dat_mollusk$Shucked_weight, na.rm = TRUE)),
         Whole_weight = coalesce(Whole_weight, median(dat_mollusk$Whole_weight, na.rm = TRUE)))

#Rename Sex column
dat_mollusk <- dat_mollusk %>% rename(Sex = `Sex (1 – male, 2 – female, 3 – uvenil)`)
dat_mollusk$Sex <- factor(dat_mollusk$Sex, levels = c("1", "2", "3"), 
                  labels = c("male", "female", "uvenil"))
```

It is not necessary but Sex column was reformated so that it became more convenient for usage and representative.
Now we have more or less clean data, though the preparation is not yet over. But from now we can try to examine our data, and the first thing to be done is to visualize our variables to check for outliers.


Our data was changed, so from now its structure is:
```{r new structure}
print(str(dat_mollusk))
```

Graphs below demonstrate the examples of distributions in our data. Not all of them are included, because mostly this distributions are very similar to each other.

```{r Height distribution, echo = FALSE}
nrow <- nrow(dat_mollusk)
ggplot(dat_mollusk, aes(x = c(1:nrow), y = Height)) +
  labs(x = "mollusks", title = "Height distribution") + theme_dark() +
  geom_boxplot(aes(fill = Sex)) + scale_fill_brewer(palette="PRGn")
```

Here we see that two values are significantly outlying from the others, first is a female with height more than 0.9 cm and second is a male with height of about 0.5 cm. Lets see what will happen if we remove this two observations:

```{r Height distribution without outliers, echo = FALSE}
dat_mollusk <- dat_mollusk[which(dat_mollusk$Height < 0.5), ]
nrow <- nrow(dat_mollusk)
ggplot(dat_mollusk, aes(x = c(1:nrow), y = Height)) +
  labs(x = "mollusks", title = "Height distribution") + theme_dark() +
  geom_boxplot(aes(fill = Sex)) + scale_fill_brewer(palette="PRGn")
```

The distribution of lengh is the following:

```{r Length distribution, echo = FALSE}
nrow <- nrow(dat_mollusk)
ggplot(dat_mollusk, aes(x = c(1:nrow), y = Length)) + theme_dark() +
  labs(x = "mollusks", title = "Length distribution") +
  geom_boxplot(aes(fill = Sex)) + scale_fill_brewer(palette="PRGn")
```

The distribution of Length here seems not to be so normal (and later it will be proven with statistical analysis), as its tails are much bigger than those for Height distribution, and we can see it on violin plot: 

```{r Length distribution (density), echo = FALSE}
nrow <- nrow(dat_mollusk)
ggplot(dat_mollusk, aes(x = c(1:nrow), y = Length)) + theme_dark() +
  labs(x = "mollusks", title = "Length distribution") + facet_grid(~ Sex) +
  geom_violin(aes(y = Length, fill = Sex)) + scale_fill_brewer(palette="PRGn")
```
Lets test our variable distributions on normality with Shapiro-Wilk test:

```{r shapiro}
p_Length <- shapiro.test(dat_mollusk$Length)$p
p_Whole_weight <- shapiro.test(dat_mollusk$Whole_weight)$p
p_Rings <- shapiro.test(dat_mollusk$Rings)$p
p_Diameter <- shapiro.test(dat_mollusk$Diameter)$p
p_Chucked_weight <- shapiro.test(dat_mollusk$Shucked_weight)$p
p_Viscera_weight <- shapiro.test(dat_mollusk$Viscera_weight)$p
p_Shell_weight <- shapiro.test(dat_mollusk$Shell_weight)$p
p_Height <- shapiro.test(dat_mollusk$Height)$p
p_data_1 <- data_frame("Height" = p_Height, "p_Length" = p_Length, "p_Whole_weight" = p_Whole_weight, "p_Rings" = p_Rings)
p_data_2 <- data_frame("p_Diameter" = p_Diameter, "p_Chucked_weight" = p_Chucked_weight, "p_Viscera_weight" = p_Viscera_weight, "p_Shell_weight" = p_Shell_weight)
print(as.data.frame(p_data_1))
print(as.data.frame(p_data_2))
```

All p-values are much smaller than 0.01 and thus we can assume that our distributions are different from normal distribution.

The best way to observe correlations between single variables is to create a correlation map:

```{r corr map, echo = FALSE}
dat_wh_sex <- dat_mollusk %>% dplyr::select(-Sex)
corr <- round(cor(dat_wh_sex), 3)  # Compute a correlation matrix
p_mat <- cor_pmat(dat_wh_sex) # Compute a matrix of correlation p-values
ggcorrplot(corr, hc.order = TRUE, type = "lower", method = "circle", p.mat = p_mat,
   outline.col = "white",
   ggtheme = ggplot2::theme_dark,
   colors = c("#6D9EC1", "white", "#E46726"))

```

Correlation map above presents the correlation relationships between every variable (Sex is not presented for now as this variable is factor and doesn't allow to prepare correlation map with this method). It shows that almost all of measured variables have strong correlation and map of p-values is presented below:
```{r p-values for correlation, echo = FALSE}
round(p_mat, 3)
```
All values that are present in the table are rounded up to 3rd digit. All p-values are much less than 0.05, which indicates that the correlation is statistically reliable.
From the graph above we can assume that the strongest correlation is between such parameters of mollusks as weight, diameter and length. Thus, we cannot use this predictors together in further analysis but we also see that such feature as the number of rings is more independent from other parameters. 


It is interesting to look at all of our distributions to reveal some patterns and dependencies.

```{r dependence map}

p <- dat_wh_sex %>% ggpairs(.,
               title = "Pairwise dependence map",
               lower = list(continuous = wrap("smooth", alpha = 0.3, size=0.1), 
                            discrete = "blank", combo="blank"), 
               diag = list(discrete="barDiag", 
                           continuous = wrap("densityDiag", alpha=0.5 )),
               upper = list(combo = wrap("box_no_facet", alpha=0.5), continuous = wrap("cor", size=4, alignPercent=0.8, colour = "black"))) + theme_dark()
               

plots = list()
for (i in 1:8){
  plots <- c(plots, lapply(2:p$ncol, function(j) getPlot(p, i = i, j = j)))
}
ggmatrix(plots, 
         nrow = 8, 
         ncol=p$ncol-1, 
         xAxisLabels = p$xAxisLabels[2:p$ncol], 
         yAxisLabels = p$yAxisLabels, 
         title="Pairwise dependence map")
```

As seen on the graph above, the parameters such as weight, length and diameter all have strong positive correlation, and this means that our mollusks change in a very similar way. It shows that the mollusks with different amount of rings can vary very widely, so the prediction of number of rings (which can be interpreted as the "age" of mollusks) using only one of other parameters can not be done accurately. But it is possible that using many parameters at once can help to predict the number of rings.



## 2. Statistic tests

In this module some key statistic examples are counted.

#### 2.1 Counting mean and sd of Length for mollusks of different sex.

As we saw on graphics above, mean and sd of Length for mollusks of different sex differs between uvenil and old animals.
Table below presents quantative values of mean and sd of Length for mollusks of different sex:

```{r mean sd, warning = FALSE, message = FALSE}
mean_sd_L <- dat_mollusk %>% group_by(Sex) %>% 
  summarise(mean = mean(Length), sd = sd(Length))
as.data.frame(mean_sd_L)
```

#### 2.2 What percentage of mollusks has the Height variable less than 0.165?

```{r small mollusks}
Small_mollusks <- round(nrow(dat_mollusk[which(dat_mollusk$Height < 0.165), ])/nrow*100, 2)
Small_mollusks
```
 More than 70% of our Mollusks have Height less than 0.165. 

#### 2.3 What Length variable is greater than 92% of all observations?

```{r great Length}
len_mol_sorted <- sort(dat_mollusk$Length)
nr <- length(len_mol_sorted)
len_mol <- len_mol_sorted[nr/100*92]
len_mol

```

#### 2.4 Length Z-scores after standartization

```{r Z-scores, echo=T}
Lenght_z_scores <- (dat_mollusk$Length - mean(dat_mollusk$Length))/sd(dat_mollusk$Length)
```

#### 2.5 Diameter and different amount of Rings

```{r rings/diameter, echo = FALSE, warning=FALSE}
subdata <- dat_mollusk[which(dat_mollusk$Rings == 5 | dat_mollusk$Rings == 15), ]
ggplot(subdata, aes(x = Diameter )) + theme_dark() +
  labs(x = "diameter", y = "amount of mollusks", title = "Diameter Variance of mollusks with 5 and 15 rings", fill = "Number of Rings")  + 
  geom_histogram(bins=30, aes(fill = factor(Rings))) + scale_fill_brewer(palette="PRGn")
```

As shown on the above graph, the diameter varies in different intervals for these two types of mollusks. The increase of the amount of rings is correlated with the diameter of mollusks and we see that our observations are well divided into two groups by the number of rings. Thus we can assume, that the bigger mollusk is the more rings it has.

#### 2.6 Diameter and Whole Weight

```{r diam & whole weight, echo = FALSE, warning=FALSE}
moll_model <- lm(Diameter ~ sqrt(Whole_weight), data=dat_mollusk)
predicted_df <- data.frame(Diameter_pred = predict(moll_model, dat_mollusk), Whole_weight=dat_mollusk$Whole_weight)
ggplot(dat_mollusk, aes(x = Diameter, y = Whole_weight)) + theme_dark() +
  labs(x = "diameter", y = "Whole weight", title = "Diameter and Whole weight dependance")  + 
  geom_point() + geom_line(data = predicted_df, aes(x=Diameter_pred, y=Whole_weight), color = "red") + scale_fill_brewer(palette="PRGn")
```

It is obvious that Diameter and Whole weight of our mollusks have non-linear dependence. We can approximate our dependence with square root function. It shows that whole weight of mollusks is proportional to the diameter squared. This can be explained if we suppose that mass of the mollusk is proportional to its diameter squared (because mass is density * volume, and volume of mollusk is proportional to its diameter squared, if we suppose that mollusk body is symmetrical and has close shape to cylinder). 

The table below shows the summary of our model:

```{r}
summary(moll_model)
```

Here we see that R-squared = 0.9419, thus the essential part of our deviation can be explained with this model.
But on this graph we also see that the deviance increases with the growth of diameter. We shall look at the graph that shows the distribution of the residuals of model's predictions:
```{r res plot, echo = FALSE, warning=FALSE}
mollusks_diag <- fortify(moll_model)
gg_resid <- ggplot(data = mollusks_diag, aes(x = .fitted, y = .resid)) +
  theme_dark() + labs(x = "Diameter", y = "res of whole weight", title = "the distribution of the residuals")+
  geom_point() 
gg_resid
```

We see that the residuals have pattern and are heteroscedastic, which means that there are unrecorded predictors that affect the distribution of weight with the increase of diameter.
It means that our model can be applied to our data, but we need to keep in mind that there can be unrecorded predictors. 

### Results

We examined a dataset of different mussel characteristics measured for more than 4000 mollusks. We tried to understand how different parameters of the mollusk can be connected to each other, and found out that almost all of our tested characteristics have highly positive correlation.  We also showed that the mollusks with different amount of rings vary widely in other characteristics. Our data shows that the mass density of mollusk is distributed uniformly. The amount of rings can not be predicted using just one variable, but it its prediction based on many features can be a material for the future study.
